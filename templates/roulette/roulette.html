<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roulette Game</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
        }
        h1, h2 {
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        #balance {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #roulette-wheel {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            border: 10px solid #f1c40f;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            background-color: #27ae60;
        }
        #ball {
            width: 30px;
            height: 30px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.05s linear;
        }
        #number-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: white;
        }
        .bet-options, .bet-amounts {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            font-size: 18px;
            padding: 10px 20px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #c0392b;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        #current-bets {
            margin-bottom: 20px;
        }
        #history {
            background-color: rgba(52, 73, 94, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        #show-full-history {
            margin-top: 10px;
            background-color: #3498db;
        }
        #show-full-history:hover {
            background-color: #2980b9;
        }
        #back-to-home {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 18px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #back-to-home:hover {
            background-color: #c0392b;
        }
        #back-to-home:focus {
            outline: none;
        }
        #number-selection {
            margin-top: 10px;
        }
        #bet-number-input {
            font-size: 18px;
            padding: 5px;
            width: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Roulette</h1>
        <button id="back-to-home" title="Back to Home">‚ùÆ</button>
        <div id="balance">Balance: $<span id="balance-amount">{{ balance }}</span></div>
        <div id="roulette-wheel">
            <div id="ball"></div>
            <div id="number-display"></div>
        </div>
        <div id="bet-selection">
            <div class="bet-options">
                <button id="bet-red">Red</button>
                <button id="bet-black">Black</button>
                <button id="bet-even">Even</button>
                <button id="bet-odd">Odd</button>
                <button id="bet-number">Number</button>
            </div>
        </div>
        <div id="bet-amounts" style="display: none;">
            <button class="bet-amount" data-amount="5">+$5</button>
            <button class="bet-amount" data-amount="10">+$10</button>
            <button class="bet-amount" data-amount="100">+$100</button>
            <button class="bet-amount" data-amount="1000">+$1000</button>
            <button id="cancel-bet">Cancel</button>
            <button id="confirm-bet">Confirm</button>
        </div>
        <div id="number-selection" style="display: none;">
            <input type="number" id="bet-number-input" min="0" max="36" step="1">
            <button id="confirm-number">Confirm Number</button>
        </div>
        <div id="current-bets"></div>
        {% csrf_token %}
        <button id="spin-roulette" style="display: none;">Spin Roulette</button>
        <div id="history">
            <h2>History</h2>
            <ul id="history-list"></ul>
        </div>
        <button id="show-full-history">Show Full History</button>
    </div>
<script>
    const csrfToken = '{{ csrf_token }}';


    $(document).ready(function() {
        let currentBetType = '';
        let currentBetAmount = 0;
        let bets = [];
        let history = [];
        let showingFullHistory = false;
        let isSpinning = false;


        function updateBalance(newBalance) {
            $('#balance-amount').text(newBalance);
        }

    function resetGame() {
        currentBetType = '';
        currentBetAmount = 0;
        bets = [];
        isSpinning = false;
        updateCurrentBets();
        enableBettingOptions();
        $('#confirm-bet').text('Confirm');
        $('#number-selection, #bet-amounts').hide();
    }
        function updateCurrentBets() {
            let betsHtml = '<h3>Current Bets:</h3>';
            bets.forEach((bet, index) => {
                betsHtml += `<p>${bet.type} - $${bet.amount} <button class="cancel-single-bet" data-index="${index}">Cancel</button></p>`;
            });
            $('#current-bets').html(betsHtml);

            $('.cancel-single-bet').click(function() {
                const index = $(this).data('index');
                bets.splice(index, 1);
                updateCurrentBets();
                if (bets.length === 0) {
                    $('#spin-roulette').hide();
                }
            });

            if (bets.length > 0) {
                $('#spin-roulette').show();
            }
        }

        function updateHistory() {
            let historyHtml = '';
            let displayHistory = showingFullHistory ? history : history.slice(0, 5);
            displayHistory.forEach(item => {
                historyHtml += `<li>${item}</li>`;
            });
            $('#history-list').html(historyHtml);
        }

        $('.bet-options button').click(function() {
            currentBetType = $(this).text().toLowerCase();
            if (currentBetType === 'number') {
                $('#number-selection').show();
                $('#bet-amounts').hide();
            } else {
                $('#bet-amounts').show();
                $('#number-selection').hide();
            }
            $('#bet-selection').hide();
        });

        $('#confirm-number').click(function() {
            const number = $('#bet-number-input').val();
            if (number >= 0 && number <= 36) {
                currentBetType = `number ${number}`;
                $('#bet-amounts').show();
                $('#number-selection').hide();
            } else {
                alert('Please enter a valid number between 0 and 36');
            }
        });

        $('.bet-amount').click(function() {
            const amount = parseInt($(this).data('amount'));
            const maxBet = currentBetType.includes('number') ? 1000 : 10000;
            if (currentBetAmount + amount <= maxBet) {
                currentBetAmount += amount;
                $('#confirm-bet').text(`Confirm $${currentBetAmount}`);
            } else {
                alert(`Maximum bet for ${currentBetType} is $${maxBet}`);
            }
        });

        $('#cancel-bet').click(function() {
            currentBetAmount = 0;
            $('#bet-selection').show();
            $('#bet-amounts').hide();
            $('#number-selection').hide();
        });

        function updateCurrentBets() {
        let betsHtml = '<h3>Current Bets:</h3>';
        bets.forEach((bet, index) => {
            betsHtml += `<p>${bet.type} - $${bet.amount} <button class="cancel-single-bet" data-index="${index}">Cancel</button></p>`;
        });
        $('#current-bets').html(betsHtml);

        $('.cancel-single-bet').click(function() {
            const index = $(this).data('index');
            bets.splice(index, 1);
            updateCurrentBets();
            updateSpinButtonState();
        });

        updateSpinButtonState();
    }
        function updateSpinButtonState() {
        if (bets.length > 0) {
            $('#spin-roulette').show().prop('disabled', false);
        } else {
            $('#spin-roulette').hide().prop('disabled', true);
        }
    }
        $('#confirm-bet').click(function() {
            if (currentBetAmount > 0) {
                bets.push({ type: currentBetType, amount: currentBetAmount });
                updateCurrentBets();
                currentBetAmount = 0;
                $('#bet-selection').show();
                $('#bet-amounts').hide();
                $('#confirm-bet').text('Confirm');
                updateSpinButtonState();
            }
        });

        $('#show-full-history').click(function() {
            showingFullHistory = !showingFullHistory;
            $(this).text(showingFullHistory ? "Show Last 5" : "Show Full History");
            updateHistory();
        });





        function disableBettingOptions() {
            $('.bet-options button, .bet-amount, #cancel-bet, #confirm-bet, #confirm-number, .cancel-single-bet').prop('disabled', true);
            $('#number-selection, #bet-amounts').hide();
        }
        function enableBettingOptions() {
        $('.bet-options button, .bet-amount, #cancel-bet, #confirm-bet, #confirm-number').prop('disabled', false);
        $('#bet-selection').show();
}

        function spinRouletteWheel(result) {
            return new Promise((resolve) => {
                const numbers = [
                    0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26
                ];
                const colors = {
                    0: 'green',
                    32: 'red', 15: 'black', 19: 'red', 4: 'black', 21: 'red', 2: 'black', 25: 'red', 17: 'black',
                    34: 'red', 6: 'black', 27: 'red', 13: 'black', 36: 'red', 11: 'black', 30: 'red', 8: 'black',
                    23: 'red', 10: 'black', 5: 'red', 24: 'black', 16: 'red', 33: 'black', 1: 'red', 20: 'black',
                    14: 'red', 31: 'black', 9: 'red', 22: 'black', 18: 'red', 29: 'black', 7: 'red', 28: 'black',
                    12: 'red', 35: 'black', 3: 'red', 26: 'black'
                };

                const resultNumber = parseInt(result);
                const targetIndex = numbers.indexOf(resultNumber);
                const totalNumbers = numbers.length;
                let currentIndex = 0;
                let spins = 0;
                const totalSpins = 3;

                let currentSpeed = 50;
                let minSpeed = 200;
                let maxSpinTime = 10000;
                let startTime = Date.now();

                function spin() {
                    if ((spins < totalSpins || currentIndex !== targetIndex) && (Date.now() - startTime < maxSpinTime)) {
                        let nextIndex = (currentIndex + 1) % totalNumbers;
                        currentIndex = nextIndex;

                        const angle = (currentIndex / totalNumbers) * 360;
                        const radians = angle * (Math.PI / 180);
                        const radius = 120;
                        const x = Math.cos(radians) * radius;
                        const y = Math.sin(radians) * radius;

                        $('#ball').css({
                            transform: `translate(${x}px, ${y}px)`
                        });

                        const currentNumber = numbers[currentIndex];
                        const currentColor = colors[currentNumber];
                        $('#number-display').text(currentNumber).css('color', currentColor);
                        $('#roulette-wheel').css('background-color', currentColor === 'red' ? '#e74c3c' : (currentColor === 'black' ? '#34495e' : '#27ae60'));

                        if (spins >= totalSpins) {
                            currentSpeed += 20;

                            if (currentIndex === targetIndex && currentSpeed >= minSpeed) {
                                finishSpin();
                                return;
                            }
                        }

                        if (currentIndex === totalNumbers - 1) {
                            spins++;
                        }

                        setTimeout(spin, currentSpeed);
                    } else {
                        finishSpin();
                    }
                }

                function finishSpin() {
                    $('#ball').css({
                        transform: 'translate(-50%, -50%)'
                    });
                    $('#number-display').text(resultNumber).css('color', colors[resultNumber]);
                    $('#roulette-wheel').css('background-color', colors[resultNumber] === 'red' ? '#e74c3c' : (colors[resultNumber] === 'black' ? '#34495e' : '#27ae60'));
                    setTimeout(resolve, 1000);
                }

                spin();
            });
        }

    $('#spin-roulette').click(function() {
            if (isSpinning) return;
            isSpinning = true;
            $(this).prop('disabled', true);
            disableBettingOptions();

        $.post('/roulette/spin/', { bets: JSON.stringify(bets), csrfmiddlewaretoken: csrfToken }, function(data) {
            const result = data.result.split(' ')[0];
            const winAmount = data.win_amount;

            spinRouletteWheel(result).then(() => {
                let message = `The ball landed on ${data.result}. `;
                if (winAmount > 0) {
                    message += `You won $${winAmount}!`;
                } else {
                    message += 'You lost.';
                }

                history.unshift(`Spin result: ${data.result}. Outcome: ${winAmount > 0 ? 'Win' : 'Loss'}`);
                updateHistory();

                Swal.fire({
                    title: 'Roulette Result',
                    text: message,
                    icon: winAmount > 0 ? 'success' : 'error',
                    confirmButtonText: 'Awesome!',
                    background: '#2c3e50',
                    color: '#ffffff',
                    confirmButtonColor: '#e74c3c'
                }).then(() => {
                    updateBalance(data.balance);
                    bets = [];
                    updateCurrentBets();
                    isSpinning = false;
                    updateSpinButtonState();
                    resetGame();
                });
            });
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('AJAX error:', textStatus, errorThrown);
            alert('Error processing the spin. Please try again.');
            isSpinning = false;
            updateSpinButtonState();
            resetGame();
        });
    });



                });

    $('#back-to-home').click(function() {
        window.location.href = '/';
    });

</script>

</body>
</html>